<!DOCTYPE html>

<html>

<head>
    <title>Example 02.05 - Custom geometry</title>

    <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="new_weather.css"> <!-- CodePen source: http://codepen.io/weaintplastic/pen/qEMZbx -->

    <style>
        html, body{
            background-color:  #5AC2E7;
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: 'Open Sans', sans-serif;
            font-size: 10px;
        }
        #loader {
            display: none;
            position: fixed;
            left: 25%;
            zoom: 10;
            -moz-transform: scale(3);
        }
        #city_name {
            position: absolute;
            padding: 25px 50px 25px 50px;
            color: white;
        }
        #city_name h1 {
            font-weight: 700;
        }
        #all {
            height: 100vh;
        }
        #info {
            height: 100%;
            padding: 25px 50px 25px 25px;
            color: #5AC2E7;
            background-color: #FFF;
            box-shadow: 15px 15px 15px 15px rgba(0,0,0,0.25);
        }
        svg:hover path {
            fill: #282828 !important;
        }
    </style>

</head>
<body>

<div class="row" id="all">
    
    <div class="col-sm-6">
        <div id="city_name">
            <h1>Bangalore</h1>
        </div>

        <div id="diagram">
        </div>
        <div class="preloader loading" id="loader">
            <span class="slice"></span>
            <span class="slice"></span>
            <span class="slice"></span>
            <span class="slice"></span>
            <span class="slice"></span>
            <span class="slice"></span>
        </div>
    </div>
    
    <div class="col-sm-6" id="info">
        <div class="row">
            <div class="col-sm-12">
                <h2>Checking the weather in a "Smart City."</h2>
                <h4>Explore results from Data Canvas' other cities.</h4>
                <div class="input-group">
                    <div class="input-group-btn">
                        <div class="btn-group">
                            <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                City Selector <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" role="menu" id="city_list">
                                <li><a href="#">Bangalore</a></li>
                                <li><a href="#">Boston</a></li>
                                <li><a href="#">Geneva</a></li>
                                <li><a href="#">Rio de Janeiro</a></li>
                                <li><a href="#">San Francisco</a></li>
                                <li><a href="#">Shanghai</a></li>
                                <li><a href="#">Singapore</a></li>
                            </ul>
                        </div>
                    </div>
                    <input type="text" class="form-control" aria-label="city_selected" id="city_selected" value="Bangalore">
                </div>
            </div>
        </div>
    </div>

</div>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>

<script type="text/javascript">
    // globals
    var original_temp;
    var original_desc;

    $('#city_list li').on('click', function(){
        var chosen = $(this).text();
        $('#city_selected').val(chosen);
        updateHex(chosen);
    });

    updateHex = function(city) {
        // initial action
        $('#loader').show();
        setTimeout( function () {
            $('#diagram').empty();
            // run update
            createHex(city);
            setTimeout( function () {
                // final action
                $('#city_name h1').text(city)
                $('#loader').fadeOut();  
            }, 500)
        }, 500)
    }

    createHex = function(city) {
        // date information
        var now = new Date();
        var year = now.getFullYear(),
            month = now.getMonth() + 1,
            from_day = now.getDate() - 1,
            day = now.getDate(),
            hour = now.getHours(),
            minute = now.getMinutes(),
            milliseconds = now.getMilliseconds();

        // clean up date figures
        if (month < 10) { month = "0" + String(month)};
        if (from_day < 10) { from_day = "0" + String(from_day)};
        if (day < 10) { day = "0" + String(day)};
        if (hour < 10) { hour = "0" + String(hour)};
        if (minute < 10) { minute = "0" + String(minute)};
        if (milliseconds < 1000) { milliseconds = "0" + String(milliseconds)};

        var from_date   = year + '-' + month + '-' + from_day + 'T' + hour + ':00:00-0800'; 
        var before_date = year + '-' + month + '-' + day + 'T' + hour + ':00:00-0800';


        var from = from_date,
            before = before_date,
            resolution = '1h',
            fields = ['temperature','light','airquality_raw','sound','humidity','dust'].join(),
            url = 'http://sensor-api.localdata.com/api/v1/aggregations?op=mean&over.city=' + city + '&from=' + from + '&before=' + before + '&resolution=' + resolution + '&fields=' + fields;

        $.ajax({url: url})
        .success( function(data) {
            var dataArray = data;
            var svgContainer = d3.select("#diagram") //create container
                    .append("svg")
                    .attr("id", "hex")
                    .attr("width", $(window).width())
                    .attr("height", $(window).height());

            var ratios = {
                    temp:  { val: 1, arr: [], },
                    light: { val: 1, arr: [], },
                    air:   { val: 1, arr: [], },
                    sound: { val: 1, arr: [], },
                    humid: { val: 1, arr: [], },
                    dust:  { val: 1, arr: [], },
                };

            for (var i = 0; i < dataArray.data.length; i++) {
                var each     = dataArray.data[i];
                ratios.temp.arr.push(each.temperature); 
                ratios.light.arr.push(each.light); 
                ratios.air.arr.push(each.airquality_raw);
                ratios.sound.arr.push(each.sound);
                ratios.humid.arr.push(each.humidity);
                ratios.dust.arr.push(each.dust);
            }

            for (attr in ratios) {
                var diff = Math.max(ratios[attr].arr) - Math.min(ratios[attr].arr);
                var sum = ratios[attr].arr.reduce(function(a, b) { return a + b; });
                ratios[attr].val = 150/(sum / ratios[attr].arr.length);
            };

            for (var i = dataArray.data.length-1; i >= 0 ; i--) {
                var each     = dataArray.data[i];
                var temp     = Math.min(200, each.temperature     *ratios.temp.val),
                    light    = Math.min(200, each.light           *ratios.light.val),
                    air      = Math.min(200, each.airquality_raw  *ratios.air.val),
                    sound    = Math.min(200, each.sound           *ratios.sound.val),
                    humid    = Math.min(200, each.humidity        *ratios.humid.val),
                    dust     = Math.min(200, each.dust            *ratios.dust.val);

                var _s32     = (Math.sqrt(3)/2);
                var xDiff    = $(window).width()/4;
                var yDiff    = $(window).height()/2;

                var pointData = [
                    // X VAR            // Y VAR
                    [temp+xDiff,        0+yDiff],             // temperature, right            
                    [(air/2)+xDiff,     air*_s32+yDiff],      // air quality
                    [-(sound/2)+xDiff,  sound*_s32+yDiff],    // sound
                    [-humid+xDiff,      0+yDiff],             // humidity
                    [-(dust/2)+xDiff,   -dust*_s32+yDiff],    // dust
                    [(light/2)+xDiff,   -light*_s32+yDiff],   // sound
                    [temp+xDiff,        0+yDiff],
                ];

                var enterElement = svgContainer.selectAll("path.area") //draw elements
                    .data([pointData]).enter().append("path")
                    .style("fill", "#FFFFFF")
                    .style("fill-opacity", 0.05)
                    .style("stroke", "#FFFFFF")
                    .style("stroke-width", "0.15px")
                    .attr("d", d3.svg.line());

                if (i < 1) {
                    enterElement.style("stroke", "#FFFFFF")
                    enterElement.style("stroke-width", "2px")

                    var names = ['temperature','airquality_raw','sound','humidity','dust','light','temperature'];
                    // now add circles for each edge
                    for (var corner = 0; corner < pointData.length; corner++) {
                        var corner_name = names[corner]
                        svgContainer.selectAll("path.area")
                            .data([[]]).enter().append("circle")
                            .attr("id", corner_name)
                            .attr("r", 5 )
                            .attr("cx", pointData[corner][0] )
                            .attr("cy", pointData[corner][1] )
                            .style("fill", "#5AC2E7")
                            .style("fill-opacity", 0.5)
                            .style("stroke", "#FFFFFF")
                            .style("stroke-width", "2px")
                            .on({
                                mouseenter: function() {
                                    toggleInfo(this, each)
                                },
                                mouseleave: function() {
                                    toggleInfo()
                                }
                            })
                    }
                }
            };

            // Get the weather
            var weather_url = "http://api.openweathermap.org/data/2.5/weather?q=" + city
            $.ajax({ url: weather_url, dataType: 'jsonp', })
            .success( function(data) {
                // set globals
                original_temp = Math.round( data.main.temp - 273.15 );
                original_desc = data.weather[0].description;

                // Add the SVG Text Element to the svgContainer
                svgContainer.selectAll("path.area")
                    .data([[]]).enter().append("text")
                    .attr("id", "title")
                    .attr("x", $(window).width()/4)
                    .attr("y", $(window).height()/2 + 20)
                    .attr("text-anchor", "middle")
                    .text( original_temp )
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "100px")
                    .attr("fill", "white")
                svgContainer.selectAll("path.area")
                    .data([[]]).enter().append("text")
                    .attr("id", "subtitle")
                    .attr("x", $(window).width()/4)
                    .attr("y", $(window).height()/2 + 50)
                    .attr("text-anchor", "middle")
                    .text( original_desc )
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "20px")
                    .attr("fill", "white")
            })
        });
    }

    toggleInfo = function(elem, data) {
        if (elem) {
            $('#title')[0].innerHTML = Math.round(data[elem.id]);
            $('#subtitle')[0].innerHTML = elem.id;
        }
        else {
            $('#title')[0].innerHTML = original_temp;
            $('#subtitle')[0].innerHTML = original_desc;
        }
    }

    createHex('Bangalore');

</script>
</body>
</html>
